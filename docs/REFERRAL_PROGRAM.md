# –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ ‚Äî –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

## –û–±–∑–æ—Ä

–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –ø—Ä–∏–≥–ª–∞—à–∞—Ç—å –¥—Ä—É–∑–µ–π –∏ –ø–æ–ª—É—á–∞—Ç—å –±–æ–Ω—É—Å—ã –≤ –≤–∏–¥–µ –º–æ–Ω–µ—Ç. –ú–æ–Ω–µ—Ç—ã –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É—é—Ç—Å—è –≤ —Å–∫–∏–¥–∫—É –Ω–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫—É Telegram Mini App.

---

## –ö–æ–Ω—Ü–µ–ø—Ü–∏—è

**–ù–∞–∑–≤–∞–Ω–∏–µ:** –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞
**–û–ø–∏—Å–∞–Ω–∏–µ:** –ü—Ä–∏–≥–ª–∞—à–∞–π—Ç–µ –¥—Ä—É–∑–µ–π –∏ –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π—Ç–µ –≤–º–µ—Å—Ç–µ

### –ù–∞–≥—Ä–∞–¥—ã

| –ü–æ–ª—É—á–∞—Ç–µ–ª—å | –ù–∞–≥—Ä–∞–¥–∞ | –û–ø–∏—Å–∞–Ω–∏–µ |
|------------|---------|----------|
| –ü—Ä–∏–≥–ª–∞—Å–∏–≤—à–∏–π (—Ä–µ—Ñ–µ—Ä–µ—Ä) | **100 –º–æ–Ω–µ—Ç** | –ó–∞ –∫–∞–∂–¥–æ–≥–æ –ø—Ä–∏–≥–ª–∞—à—ë–Ω–Ω–æ–≥–æ –¥—Ä—É–≥–∞ |
| –ü—Ä–∏–≥–ª–∞—à—ë–Ω–Ω—ã–π (—Ä–µ—Ñ–µ—Ä–∞–ª) | **50 –º–æ–Ω–µ—Ç** | –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –±–æ–Ω—É—Å –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –∫–æ–¥—É |

---

## –£—Ä–æ–≤–Ω–∏ –ø–∞—Ä—Ç–Ω—ë—Ä–∞ (Tiers)

| –£—Ä–æ–≤–µ–Ω—å | –†–µ—Ñ–µ—Ä–∞–ª–æ–≤ | –ö–æ–º–∏—Å—Å–∏—è | –¶–≤–µ—Ç |
|---------|-----------|----------|------|
| Bronze | 0-9 | 10% | amber-700 |
| Silver | 10-29 | 15% | gray-400 |
| Gold | 30-99 | 20% | amber-400 |
| Platinum | 100+ | 30% | purple-500 |

**–ö–æ–º–∏—Å—Å–∏—è** ‚Äî –ø—Ä–æ—Ü–µ–Ω—Ç –æ—Ç –∑–∞—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –º–æ–Ω–µ—Ç —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–ª—É—á–∞–µ—Ç —Ä–µ—Ñ–µ—Ä–µ—Ä.

---

## –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### –¢–∞–±–ª–∏—Ü–∞ `users` (–ø–æ–ª—è –¥–ª—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã)

```sql
-- –ü–æ–ª—è –≤ —Ç–∞–±–ª–∏—Ü–µ users
referral_code VARCHAR(50) UNIQUE NOT NULL,     -- –£–Ω–∏–∫–∞–ª—å–Ω—ã–π —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
referred_by_code VARCHAR(50),                   -- –ö–æ–¥ —Ç–æ–≥–æ, –∫—Ç–æ –ø—Ä–∏–≥–ª–∞—Å–∏–ª
total_referrals INTEGER DEFAULT 0 NOT NULL,    -- –í—Å–µ–≥–æ –ø—Ä–∏–≥–ª–∞—à—ë–Ω–Ω—ã—Ö
active_referrals INTEGER DEFAULT 0 NOT NULL,   -- –ê–∫—Ç–∏–≤–Ω—ã—Ö —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤
tier VARCHAR(50) DEFAULT 'Bronze',             -- –£—Ä–æ–≤–µ–Ω—å –ø–∞—Ä—Ç–Ω—ë—Ä–∞
total_earnings DECIMAL(10,2) DEFAULT 0,        -- –í—Å–µ–≥–æ –∑–∞—Ä–∞–±–æ—Ç–∞–Ω–æ —Å —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤
total_coins INTEGER DEFAULT 0,                 -- –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–æ–Ω–µ—Ç
available_coins INTEGER DEFAULT 0,             -- –î–æ—Å—Ç—É–ø–Ω—ã–µ –º–æ–Ω–µ—Ç—ã

-- –ò–Ω–¥–µ–∫—Å
CREATE INDEX idx_users_referral_code ON users(referral_code);
```

### –¢–∞–±–ª–∏—Ü–∞ `referrals`

```sql
CREATE TABLE referrals (
  id SERIAL PRIMARY KEY,
  referrer_telegram_id BIGINT NOT NULL REFERENCES users(telegram_id) ON DELETE CASCADE,
  referred_telegram_id BIGINT NOT NULL REFERENCES users(telegram_id) ON DELETE CASCADE,
  bonus_amount DECIMAL(10, 2) DEFAULT 0 NOT NULL,
  status VARCHAR(50) DEFAULT 'pending' NOT NULL,
  created_at TIMESTAMP DEFAULT NOW() NOT NULL
);

-- –ò–Ω–¥–µ–∫—Å—ã
CREATE INDEX idx_referrals_referrer_id ON referrals(referrer_telegram_id);
CREATE INDEX idx_referrals_referred_id ON referrals(referred_telegram_id);
CREATE INDEX idx_referrals_status ON referrals(status);
CREATE INDEX idx_referrals_created_at ON referrals(created_at);
```

### –û–ø–∏—Å–∞–Ω–∏–µ –ø–æ–ª–µ–π —Ç–∞–±–ª–∏—Ü—ã `referrals`

| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| `id` | SERIAL | –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –∑–∞–ø–∏—Å–∏ |
| `referrer_telegram_id` | BIGINT | Telegram ID —Ç–æ–≥–æ, –∫—Ç–æ –ø—Ä–∏–≥–ª–∞—Å–∏–ª |
| `referred_telegram_id` | BIGINT | Telegram ID –ø—Ä–∏–≥–ª–∞—à—ë–Ω–Ω–æ–≥–æ |
| `bonus_amount` | DECIMAL(10,2) | –°—É–º–º–∞ –±–æ–Ω—É—Å–∞ (100 –º–æ–Ω–µ—Ç) |
| `status` | VARCHAR(50) | –°—Ç–∞—Ç—É—Å: `pending`, `active`, `inactive` |
| `created_at` | TIMESTAMP | –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø–∏—Å–∏ |

---

## –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞

```typescript
function generateReferralCode(): string {
  return 'WEB4TG' + Math.random().toString(36).substring(2, 8).toUpperCase();
}

// –ü—Ä–∏–º–µ—Ä—ã:
// WEB4TG7X9K2M
// WEB4TGAB3F5Z
// WEB4TGQ8N1P4
```

**–§–æ—Ä–º–∞—Ç –∫–æ–¥–∞:** `WEB4TG` + 6 —Å–ª—É—á–∞–π–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤ (–±—É–∫–≤—ã A-Z –∏ —Ü–∏—Ñ—Ä—ã 0-9)

---

## API —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã

### 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–º –∫–æ–¥–æ–º)

**Endpoint:** `POST /api/referrals/user/init`

**Headers:**
```
Content-Type: application/json
x-telegram-init-data: {Telegram WebApp initData}
```

**Request Body:**
```json
{
  "referred_by_code": "WEB4TG7X9K2M"
}
```

**Response (–Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å):**
```json
{
  "telegramId": 123456789,
  "username": "johndoe",
  "firstName": "John",
  "lastName": "Doe",
  "referralCode": "WEB4TGAB3F5Z",
  "referredByCode": "WEB4TG7X9K2M",
  "totalReferrals": 0,
  "activeReferrals": 0,
  "tier": "Bronze",
  "totalCoins": 50,
  "availableCoins": 50
}
```

**–õ–æ–≥–∏–∫–∞:**
```
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –ë–î
2. –ï—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç ‚Äî –≤–µ—Ä–Ω—É—Ç—å –¥–∞–Ω–Ω—ã–µ
3. –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
   a. –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–π referralCode
   b. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å referred_by_code (–µ—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω)
   c. –ï—Å–ª–∏ –µ—Å—Ç—å referred_by_code:
      - –ù–∞–π—Ç–∏ —Ä–µ—Ñ–µ—Ä–µ—Ä–∞ –ø–æ –∫–æ–¥—É
      - –°–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å –≤ —Ç–∞–±–ª–∏—Ü–µ referrals
      - –ù–∞—á–∏—Å–ª–∏—Ç—å 100 –º–æ–Ω–µ—Ç —Ä–µ—Ñ–µ—Ä–µ—Ä—É
      - –ù–∞—á–∏—Å–ª–∏—Ç—å 50 –º–æ–Ω–µ—Ç –Ω–æ–≤–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
      - –û–±–Ω–æ–≤–∏—Ç—å —Å—á—ë—Ç—á–∏–∫–∏ —Ä–µ—Ñ–µ—Ä–µ—Ä–∞ (totalReferrals, activeReferrals)
      - –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å tier —Ä–µ—Ñ–µ—Ä–µ—Ä–∞
```

---

### 2. –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã

**Endpoint:** `GET /api/referrals/stats/{telegram_id}`

**Headers:**
```
x-telegram-init-data: {Telegram WebApp initData}
```

**Response:**
```json
{
  "telegramId": 123456789,
  "referralCode": "WEB4TGAB3F5Z",
  "totalReferrals": 15,
  "activeReferrals": 12,
  "tier": "Silver",
  "totalEarnings": "1500.00",
  "totalCoins": 2350,
  "availableCoins": 1850
}
```

---

### 3. –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤

**Endpoint:** `GET /api/referrals/referrals/{telegram_id}`

**Response:**
```json
[
  {
    "telegramId": 987654321,
    "username": "friend1",
    "firstName": "Alice",
    "lastName": "Smith",
    "bonusAmount": "100.00",
    "status": "active",
    "createdAt": "2025-01-15T10:30:00Z"
  },
  {
    "telegramId": 456789123,
    "username": "friend2",
    "firstName": "Bob",
    "lastName": null,
    "bonusAmount": "100.00",
    "status": "active",
    "createdAt": "2025-01-14T15:45:00Z"
  }
]
```

---

### 4. –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥

**Endpoint:** `POST /api/referral/apply`

**Headers:**
```
Content-Type: application/json
x-telegram-init-data: {Telegram WebApp initData}
```

**Request Body:**
```json
{
  "userId": 123456789,
  "referralCode": "WEB4TG7X9K2M"
}
```

**Response (—É—Å–ø–µ—Ö):**
```json
{
  "success": true,
  "message": "Referral code applied successfully"
}
```

**Response (–æ—à–∏–±–∫–∞ ‚Äî —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω):**
```json
{
  "error": "Duplicate entry",
  "message": "–í—ã —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥"
}
```

---

### 5. Webhook –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö —Å–æ–±—ã—Ç–∏–π

**Endpoint:** `POST /api/webhooks/referral`

**Request Body:**
```json
{
  "event": "conversion",
  "referralCode": "WEB4TG7X9K2M",
  "userId": 123456789,
  "amount": 100,
  "metadata": {}
}
```

**–°–æ–±—ã—Ç–∏—è:**
- `signup` ‚Äî —Ä–µ—Ñ–µ—Ä–∞–ª –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª—Å—è
- `conversion` ‚Äî —Ä–µ—Ñ–µ—Ä–∞–ª —Å–æ–≤–µ—Ä—à–∏–ª —Ü–µ–ª–µ–≤–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ
- `purchase` ‚Äî —Ä–µ—Ñ–µ—Ä–∞–ª –æ–ø–ª–∞—Ç–∏–ª –∑–∞–∫–∞–∑

---

## –õ–æ–≥–∏–∫–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –±–æ–Ω—É—Å–æ–≤

### –ü—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–º –∫–æ–¥–æ–º

```typescript
// 1. –°–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å —Ä–µ—Ñ–µ—Ä–∞–ª–∞
await db.insert(referrals).values({
  referrerTelegramId: referrer.telegramId,
  referredTelegramId: telegram_id,
  bonusAmount: "100",
  status: 'active',
});

// 2. –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Ä–µ—Ñ–µ—Ä–µ—Ä–∞
const newTotalReferrals = (referrer.totalReferrals || 0) + 1;
await db.update(users)
  .set({
    totalReferrals: newTotalReferrals,
    activeReferrals: (referrer.activeReferrals || 0) + 1,
    totalEarnings: sql`${users.totalEarnings} + 100`,
    tier: calculateTier(newTotalReferrals),
  })
  .where(eq(users.telegramId, referrer.telegramId));

// 3. –ù–∞—á–∏—Å–ª–∏—Ç—å 100 –º–æ–Ω–µ—Ç —Ä–µ—Ñ–µ—Ä–µ—Ä—É
const REFERRAL_COINS_REWARD = 100;
await db.update(users)
  .set({
    totalCoins: sql`COALESCE(${users.totalCoins}, 0) + ${REFERRAL_COINS_REWARD}`,
    availableCoins: sql`COALESCE(${users.availableCoins}, 0) + ${REFERRAL_COINS_REWARD}`,
  })
  .where(eq(users.telegramId, referrer.telegramId));

// 4. –ù–∞—á–∏—Å–ª–∏—Ç—å 50 –º–æ–Ω–µ—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –±–æ–Ω—É—Å–∞ –Ω–æ–≤–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
const WELCOME_BONUS = 50;
await db.update(users)
  .set({
    totalCoins: WELCOME_BONUS,
    availableCoins: WELCOME_BONUS,
  })
  .where(eq(users.telegramId, telegram_id));
```

### –†–∞—Å—á—ë—Ç —É—Ä–æ–≤–Ω—è (Tier)

```typescript
function calculateTier(totalReferrals: number): string {
  if (totalReferrals >= 100) return 'Platinum';
  if (totalReferrals >= 30) return 'Gold';
  if (totalReferrals >= 10) return 'Silver';
  return 'Bronze';
}
```

---

## –ö–ª–∏–µ–Ω—Ç—Å–∫–∞—è —á–∞—Å—Ç—å (React)

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç `ReferralProgram.tsx`

**–ü—É—Ç—å:** `client/src/components/ReferralProgram.tsx`

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

#### –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞

```typescript
const handleCopyCode = useCallback(async () => {
  if (!stats.referralCode) {
    toast({
      title: t('referral.error'),
      description: t('referral.codeNotFound'),
      variant: 'destructive'
    });
    return;
  }

  navigator.clipboard.writeText(stats.referralCode);
  
  toast({
    title: t('referral.codeCopied'),
    description: `${t('referral.yourCodeIs')} ${stats.referralCode}`,
  });
}, [stats.referralCode, toast, t]);
```

#### –ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Å—Å—ã–ª–∫–æ–π —á–µ—Ä–µ–∑ Telegram

```typescript
const handleShareLink = useCallback(async () => {
  if (!stats.referralCode) {
    toast({
      title: t('referral.error'),
      description: t('referral.codeNotFound'),
      variant: 'destructive'
    });
    return;
  }

  // –ò—Å–ø–æ–ª—å–∑—É–µ–º Telegram WebApp API –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è
  const result = inviteFriend(stats.referralCode);
  
  if (result.success) {
    toast({
      title: t('referral.inviteSent'),
      description: `${stats.referralCode} ${t('referral.codeAddedToLink')} https://t.me/w4tg_bot/w4tg`,
    });
  } else {
    toast({
      title: t('referral.error'),
      description: t('referral.telegramError'),
      variant: 'destructive'
    });
  }
}, [stats.referralCode, inviteFriend, toast, t]);
```

#### –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞

```typescript
const handleApplyCode = useCallback(async () => {
  if (!user?.id || !referralCodeInput || !initData) return;

  try {
    const res = await fetch('/api/referrals/user/init', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-telegram-init-data': initData,
      },
      body: JSON.stringify({
        referred_by_code: referralCodeInput,
      }),
    });

    if (!res.ok) {
      throw new Error('Failed to apply referral code');
    }

    await refetch();

    toast({
      title: t('referral.codeApplied'),
      description: t('referral.welcomeBonus'),
    });
  } catch (error) {
    console.error('Error applying referral code:', error);
    toast({
      title: t('referral.error'),
      description: t('referral.applyError'),
      variant: 'destructive'
    });
  }
}, [user, referralCodeInput, initData, refetch, toast, t]);
```

---

## –°—Å—ã–ª–∫–∞ –¥–ª—è –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è

**–§–æ—Ä–º–∞—Ç:** `https://t.me/w4tg_bot/w4tg?startapp={referralCode}`

**–ü—Ä–∏–º–µ—Ä:** `https://t.me/w4tg_bot/w4tg?startapp=WEB4TG7X9K2M`

–ü—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –ø–æ —Å—Å—ã–ª–∫–µ:
1. Telegram –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –±–æ—Ç–∞ `@w4tg_bot`
2. –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è Mini App `w4tg`
3. –ü–∞—Ä–∞–º–µ—Ç—Ä `startapp` –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –≤ WebApp –∫–∞–∫ `start_param`
4. –ö–ª–∏–µ–Ω—Ç –∏–∑–≤–ª–µ–∫–∞–µ—Ç –∫–æ–¥ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏

---

## Telegram Bot –∫–æ–º–∞–Ω–¥—ã

| –ö–æ–º–∞–Ω–¥–∞ | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|----------|
| `/referral` | –û—Ç–∫—Ä—ã—Ç—å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É |

### –û—Ç–≤–µ—Ç –±–æ—Ç–∞ –Ω–∞ `/referral`

```
üí∞ –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞

üìä –í–∞—à–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:
‚îú –ü—Ä–∏–≥–ª–∞—à–µ–Ω–æ: 15 –¥—Ä—É–∑–µ–π
‚îú –ê–∫—Ç–∏–≤–Ω—ã—Ö: 12
‚îî –ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ: 1500 –º–æ–Ω–µ—Ç

üéÅ –í–∞—à —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥:
WEB4TG7X9K2M

üì§ –ü–æ–¥–µ–ª–∏—Ç–µ—Å—å –∫–æ–¥–æ–º —Å –¥—Ä—É–∑—å—è–º–∏ –∏ –ø–æ–ª—É—á–∏—Ç–µ 100 –º–æ–Ω–µ—Ç –∑–∞ –∫–∞–∂–¥–æ–≥–æ!

–û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –≤–∞—à–µ–π —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–∏
```

---

## –°—Ç–∞—Ç—É—Å—ã —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤

| –°—Ç–∞—Ç—É—Å | –û–ø–∏—Å–∞–Ω–∏–µ |
|--------|----------|
| `pending` | –†–µ—Ñ–µ—Ä–∞–ª –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª—Å—è, –Ω–æ –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω |
| `active` | –†–µ—Ñ–µ—Ä–∞–ª –∞–∫—Ç–∏–≤–µ–Ω (–≤—ã–ø–æ–ª–Ω—è–µ—Ç –¥–µ–π—Å—Ç–≤–∏—è) |
| `inactive` | –†–µ—Ñ–µ—Ä–∞–ª –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω (–¥–∞–≤–Ω–æ –Ω–µ –∑–∞—Ö–æ–¥–∏–ª) |

---

## –ó–∞—â–∏—Ç–∞ –æ—Ç –Ω–∞–∫—Ä—É—Ç–æ–∫

1. **Rate Limiting** ‚Äî –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —á–∞—Å—Ç–æ—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤
   ```typescript
   app.use('/api/referrals/', sensitiveEndpointLimiter);
   app.use('/api/referral/', createBurstRateLimitMiddleware());
   ```

2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤** ‚Äî –æ–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥
   ```typescript
   const [existingReferral] = await db.select().from(referrals)
     .where(eq(referrals.referredTelegramId, userId));
   
   if (existingReferral) {
     return duplicateEntryError(res, '–í—ã —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥');
   }
   ```

3. **–°–∞–º–æ—Ä–µ—Ñ–µ—Ä–∞–ª –∑–∞–ø—Ä–µ—â—ë–Ω** ‚Äî –Ω–µ–ª—å–∑—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–≤–æ–π —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –∫–æ–¥

4. **Telegram –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è** ‚Äî –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è —á–µ—Ä–µ–∑ `verifyTelegramUser`

---

## –¢–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (UI)

### –†—É—Å—Å–∫–∏–π

| –ö–ª—é—á | –¢–µ–∫—Å—Ç |
|------|-------|
| title | –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ |
| subtitle | –ü—Ä–∏–≥–ª–∞—à–∞–π—Ç–µ –¥—Ä—É–∑–µ–π –∏ –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π—Ç–µ –≤–º–µ—Å—Ç–µ |
| yourCode | –í–∞—à —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥ |
| shareCode | –ü–æ–¥–µ–ª–∏—Ç–µ—Å—å –∫–æ–¥–æ–º —Å –¥—Ä—É–∑—å—è–º–∏ |
| copy | –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å |
| copied | –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ! |
| share | –ü–æ–¥–µ–ª–∏—Ç—å—Å—è |
| yourLevel | –í–∞—à —É—Ä–æ–≤–µ–Ω—å |
| commission | –ö–æ–º–∏—Å—Å–∏—è |
| youReceive | –í—ã –ø–æ–ª—É—á–∞–µ—Ç–µ |
| friendReceives | –î—Ä—É–≥ –ø–æ–ª—É—á–∞–µ—Ç |
| totalReferrals | –í—Å–µ–≥–æ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ |
| totalEarned | –í—Å–µ–≥–æ –∑–∞—Ä–∞–±–æ—Ç–∞–Ω–æ |
| haveCode | –ï—Å—Ç—å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥? |
| enterCode | –í–≤–µ–¥–∏—Ç–µ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥ |
| enterCodeDesc | –ï—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥ –æ—Ç –¥—Ä—É–≥–∞, –≤–≤–µ–¥–∏—Ç–µ –µ–≥–æ –Ω–∏–∂–µ, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –±–æ–Ω—É—Å! |
| apply | –ü—Ä–∏–º–µ–Ω–∏—Ç—å |
| codeApplied | –†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥ –ø—Ä–∏–º–µ–Ω–µ–Ω! |
| welcomeBonus | –í—ã –ø–æ–ª—É—á–∏–ª–∏ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –±–æ–Ω—É—Å |
| codeCopied | –ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω |
| inviteSent | –ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ |

### –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç (—à–∞–≥–∏)

| –®–∞–≥ | –ó–∞–≥–æ–ª–æ–≤–æ–∫ | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----|-----------|----------|
| 1 | –ü–æ–¥–µ–ª–∏—Ç–µ—Å—å –∫–æ–¥–æ–º | –û—Ç–ø—Ä–∞–≤—å—Ç–µ –¥—Ä—É–∑—å—è–º –≤–∞—à —É–Ω–∏–∫–∞–ª—å–Ω—ã–π —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥ |
| 2 | –î—Ä—É–≥ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è | –í–∞—à –¥—Ä—É–≥ –≤–≤–æ–¥–∏—Ç –∫–æ–¥ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∏ –ø–æ–ª—É—á–∞–µ—Ç 50 –º–æ–Ω–µ—Ç |
| 3 | –ü–æ–ª—É—á–∞–π—Ç–µ –≤–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏—è | –í—ã –ø–æ–ª—É—á–∞–µ—Ç–µ 100 –º–æ–Ω–µ—Ç –∑–∞ –∫–∞–∂–¥–æ–≥–æ –¥—Ä—É–≥–∞ |

---

## –§–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞

| –§–∞–π–ª | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|----------|
| `shared/schema.ts` | –°—Ö–µ–º–∞ –ë–î ‚Äî —Ç–∞–±–ª–∏—Ü—ã users –∏ referrals |
| `server/routes.ts` | API —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã (—Å—Ç—Ä–æ–∫–∏ 2268-2500+) |
| `client/src/components/ReferralProgram.tsx` | React –∫–æ–º–ø–æ–Ω–µ–Ω—Ç |
| `client/src/lib/translations.ts` | –ü–µ—Ä–µ–≤–æ–¥—ã (—Å—Ç—Ä–æ–∫–∏ 937-987 RU) |

---

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Telegram WebApp

### –ü–æ–ª—É—á–µ–Ω–∏–µ start_param (—Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞)

```typescript
// –í Telegram WebApp
const tg = window.Telegram?.WebApp;
const startParam = tg?.initDataUnsafe?.start_param;

// startParam = "WEB4TG7X9K2M" (–µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ—à—ë–ª –ø–æ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–µ)
```

### –§—É–Ω–∫—Ü–∏—è inviteFriend

```typescript
function inviteFriend(referralCode: string) {
  const tg = window.Telegram?.WebApp;
  
  if (tg?.switchInlineQuery) {
    // –û—Ç–∫—Ä—ã—Ç—å –≤—ã–±–æ—Ä —á–∞—Ç–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è
    tg.switchInlineQuery(referralCode, ['users']);
    return { success: true };
  }
  
  return { success: false };
}
```

---

## –ú–µ—Ç—Ä–∏–∫–∏ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞

–°–∏—Å—Ç–µ–º–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç:
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–π –ø–æ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–º —Å—Å—ã–ª–∫–∞–º
- –ö–æ–Ω–≤–µ—Ä—Å–∏—é —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ –≤ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –û–±—â–∏–π –∑–∞—Ä–∞–±–æ—Ç–æ–∫ —Å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã
- –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ —É—Ä–æ–≤–Ω—è–º (Bronze/Silver/Gold/Platinum)
